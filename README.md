# Environment Fabric

> **Ray çš„ç¯å¢ƒä¾›åº”æ’ä»¶** â€” åŸºäº UV + NAS + Hardlink çš„ AOT é¢„æ„å»ºè™šæ‹Ÿç¯å¢ƒç®¡ç†æœåŠ¡

---

## ğŸ¯ é¡¹ç›®å®šä½

**Environment Fabric ä¸æ˜¯ Ray çš„æ›¿ä»£å“ï¼Œè€Œæ˜¯ Ray çš„ã€Œç¯å¢ƒä¾›åº”æ’ä»¶ã€ã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç³»ç»Ÿæ¶æ„å®šä½                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     Environment Fabric       â”‚   API   â”‚      Execution Engine             â”‚ â”‚
â”‚  â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚ â”‚
â”‚  â”‚     â€¢ AOT é¢„æ„å»ºç¯å¢ƒ          â”‚         â”‚      â€¢ Ray                        â”‚ â”‚
â”‚  â”‚     â€¢ NAS å…±äº«å­˜å‚¨ + Hardlink â”‚   è¾“å‡º   â”‚      â€¢ Celery                     â”‚ â”‚
â”‚  â”‚     â€¢ pyproject.toml + uv.lockâ”‚  è·¯å¾„   â”‚      â€¢ Kubernetes Job             â”‚ â”‚
â”‚  â”‚     â€¢ ç¯å¢ƒç”Ÿå‘½å‘¨æœŸç®¡ç†         â”‚         â”‚      â€¢ Docker / subprocess        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â”‚  äº§å‡ºï¼šæ ‡å‡†çš„ .venv è·¯å¾„ï¼ˆå¦‚ /mnt/nas/envs/wf-001/node-A/.venv/bin/pythonï¼‰      â”‚
â”‚  æ¶ˆè´¹è€…ï¼šä»»ä½•èƒ½ä½¿ç”¨ Python è§£é‡Šå™¨è·¯å¾„çš„æ‰§è¡Œå¼•æ“                                    â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ ä¸ Ray çš„èåˆæ–¹æ¡ˆï¼š`py_executable`

åˆ©ç”¨ Ray çš„ `py_executable` å‚æ•°ï¼ˆå®éªŒæ€§åŠŸèƒ½ï¼‰ï¼Œå¯ä»¥è®© Ray Worker ç›´æ¥ä½¿ç”¨ Environment Fabric é¢„æ„å»ºçš„ Python ç¯å¢ƒï¼š

```python
import ray

# 1. Environment Fabric é¢„å…ˆæ„å»ºçš„ç¯å¢ƒè·¯å¾„ï¼ˆä½äº NAS å…±äº«å­˜å‚¨ï¼‰
#    æ‰€æœ‰ Ray Worker èŠ‚ç‚¹é€šè¿‡ NFS æŒ‚è½½åŒä¸€è·¯å¾„
PREBUILT_PYTHON = "/mnt/nas/envs/workflow-001/node-A/.venv/bin/python"

# 2. å®šä¹‰ runtime_envï¼Œå‘Šè¯‰ Rayï¼š"åˆ«è‡ªå·±è£…åŒ…äº†ï¼Œç›´æ¥ç”¨æˆ‘ç»™ä½ çš„è¿™ä¸ª Python"
runtime_env = {
    "py_executable": PREBUILT_PYTHON,  # å…³é”®ï¼šæŒ‡å®š Worker å¯åŠ¨æ—¶ä½¿ç”¨çš„è§£é‡Šå™¨
    "working_dir": "./my_project_code"  # ä»å¯æŒ‚è½½ä»£ç ç›®å½•
}

@ray.remote(runtime_env=runtime_env)
def heavy_computing_task():
    import sys
    import torch
    # è¿™é‡Œä½¿ç”¨çš„æ˜¯ Environment Fabric é¢„æ„å»ºçš„ç¯å¢ƒ
    return f"Running on {sys.executable} with torch {torch.__version__}"

# 3. æ‰§è¡Œ
ray.init()
print(ray.get(heavy_computing_task.remote()))
```

> [!TIP]
> **èåˆæ¶æ„çš„æ ¸å¿ƒæ€æƒ³**
> 
> - **Environment Fabric**ï¼šè´Ÿè´£ AOT é¢„æ„å»ºç¯å¢ƒï¼Œäº§å‡º `.venv` è·¯å¾„
> - **Ray**ï¼šè´Ÿè´£ JIT ä»»åŠ¡è°ƒåº¦ï¼Œé€šè¿‡ `py_executable` ä½¿ç”¨é¢„æ„å»ºç¯å¢ƒ
> - **ç»“æœ**ï¼šç¯å¢ƒæ„å»ºä¸ä»»åŠ¡æ‰§è¡Œè§£è€¦ï¼Œä¸¤è€…å„å¸å…¶èŒ

---

## ğŸš€ ä¸ºä»€ä¹ˆéœ€è¦ Environment Fabricï¼Ÿ

Ray çš„ `runtime_env` è™½ç„¶å¼ºå¤§ï¼Œä½†å®ƒæœ¬è´¨ä¸Šæ˜¯ **"åˆ†å¸ƒå¼çš„ã€èŠ‚ç‚¹æœ¬åœ°çš„ã€JIT çš„"**ã€‚
è€Œ Environment Fabric æ˜¯ **"ä¸­å¿ƒåŒ–çš„ã€å…¨å±€å…±äº«çš„ã€AOT çš„"**ã€‚

ä»¥ä¸‹ 4 ä¸ªç”Ÿäº§çº§åœºæ™¯ï¼ŒRay åŸç”Ÿæ–¹æ¡ˆè§£å†³ä¸äº†ï¼Œè€Œ Environment Fabric æ˜¯å®Œç¾è§£æ³•ï¼š

### åœºæ™¯ä¸€ï¼šå¤§è§„æ¨¡ SaaS å¹³å°ï¼ˆ10000+ ç¯å¢ƒï¼‰

> **é—®é¢˜**ï¼šç£ç›˜æˆæœ¬çˆ†ç‚¸

| æ¶æ„ | 10 å°æœºå™¨ Ã— å®‰è£… torch (2GB) | æ€»ç£ç›˜å ç”¨ |
|------|------------------------------|-----------|
| Ray Runtime Env (Node-local) | æ¯å°æœºå™¨ç‹¬ç«‹å®‰è£… | **20 GB** |
| Environment Fabric (NAS + Hardlink) | å…±äº«å­˜å‚¨ + ç¡¬é“¾æ¥ | **2 GB** |

**Environment Fabric æ–¹æ¡ˆ**ï¼š
- æ‰€æœ‰ç¯å¢ƒæ„å»ºåœ¨ NAS å…±äº«å­˜å‚¨ä¸Š
- åˆ©ç”¨ `uv` çš„ Hardlink æœºåˆ¶ï¼Œç›¸åŒåŒ…åªå ç”¨ä¸€ä»½ç‰©ç†ç©ºé—´
- **èŠ‚çœ 90% ä»¥ä¸Šå­˜å‚¨æˆæœ¬**

```
NAS å…±äº«å­˜å‚¨æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /mnt/nas/                        <- NFS/EFS æŒ‚è½½ç‚¹                 â”‚
â”‚    â”‚                                                                â”‚
â”‚    â”œâ”€â”€ envs/                      <- æ‰€æœ‰ç¯å¢ƒ                       â”‚
â”‚    â”‚   â”œâ”€â”€ wf-001_node-A/.venv/   <- ç¯å¢ƒA (torch)                 â”‚
â”‚    â”‚   â”œâ”€â”€ wf-001_node-B/.venv/   <- ç¯å¢ƒB (torch)  â”€â”€â”            â”‚
â”‚    â”‚   â””â”€â”€ wf-002_node-C/.venv/   <- ç¯å¢ƒC (torch)  â”€â”€â”¼â”€ Hardlink  â”‚
â”‚    â”‚                                                  â”‚             â”‚
â”‚    â””â”€â”€ uv_cache/                  <- å…¨å±€ç¼“å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â””â”€â”€ torch-2.0.0.whl        <- ç‰©ç†æ–‡ä»¶åªå­˜ä¸€ä»½               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### åœºæ™¯äºŒï¼šç”Ÿäº§ç¯å¢ƒé›¶å†·å¯åŠ¨

> **é—®é¢˜**ï¼šRay JIT å¯¼è‡´ä»»åŠ¡å†·å¯åŠ¨ä¸å¯æ§

```mermaid
sequenceDiagram
    participant User
    participant Ray as Ray (JIT æ¨¡å¼)
    participant EnvFabric as Environment Fabric (AOT æ¨¡å¼)
    participant Task

    Note over Ray: Ray åŸç”Ÿæ–¹æ¡ˆ - å†·å¯åŠ¨
    User->>Ray: æäº¤ä»»åŠ¡
    Ray->>Ray: å‘ç°æ²¡ç¯å¢ƒ
    Ray->>Ray: å¼€å§‹æ„å»ºç¯å¢ƒï¼ˆå¯èƒ½è€—æ—¶æ•°åˆ†é’Ÿï¼‰
    Ray->>Task: ç­‰å¾…... æ‰§è¡Œä»»åŠ¡

    Note over EnvFabric: Environment Fabric æ–¹æ¡ˆ - é¢„çƒ­
    User->>EnvFabric: ä¿å­˜å·¥ä½œæµé…ç½®
    EnvFabric->>EnvFabric: åå°é™é»˜æ„å»ºç¯å¢ƒ âœ…
    Note over User: ç¨å...
    User->>EnvFabric: ç‚¹å‡»è¿è¡Œ
    EnvFabric->>Task: ç¯å¢ƒå·²å°±ç»ª â†’ æ¯«ç§’çº§å¯åŠ¨ ğŸš€
```

**Environment Fabric æ–¹æ¡ˆ**ï¼š
- **AOT é¢„æ„å»º**ï¼šç”¨æˆ·ç¼–è¾‘å®Œå·¥ä½œæµ â†’ ä¿å­˜ â†’ åå°é™é»˜æ„å»ºç¯å¢ƒ
- **æ¯«ç§’çº§å¯åŠ¨**ï¼šè¿è¡Œæ—¶ç¯å¢ƒå·²å°±ç»ªï¼ŒRay ç›´æ¥ä½¿ç”¨ `py_executable`
- **è§£è€¦æ„å»ºä¸æ‰§è¡Œ**ï¼šç¯å¢ƒæ„å»ºä½œä¸ºç‹¬ç«‹ç¯èŠ‚ï¼Œä¸é˜»å¡ä»»åŠ¡è°ƒåº¦

---

### åœºæ™¯ä¸‰ï¼šå¯è°ƒè¯•çš„ç™½ç›’ç¯å¢ƒ

> **é—®é¢˜**ï¼šRay ç¯å¢ƒæ˜¯é»‘ç›’ï¼Œæ•…éšœéš¾æ’æŸ¥

| ç»´åº¦ | Ray Runtime Env | Environment Fabric |
|------|-----------------|-------------------|
| ç¯å¢ƒä½ç½® | ä¸´æ—¶ç›®å½•ï¼Œè¢« GC åæ¶ˆå¤± | æŒä¹…åŒ–ç‰©ç†è·¯å¾„ |
| æ•…éšœæ’æŸ¥ | åªèƒ½çœ‹ Ray æ—¥å¿— | å¯ SSH è¿›å» `source .venv/bin/activate` |
| ç¯å¢ƒå›æ»š | ä¸æ”¯æŒ | å¯å¯¹ç¯å¢ƒåš Snapshot |
| ç¡®å®šæ€§ | pip list æ¾æ•£ | `uv.lock` å­—èŠ‚çº§é”å®š |

**Environment Fabric æ–¹æ¡ˆ**ï¼š
- ç¯å¢ƒæ˜¯ç‰©ç†å­˜åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯éšæ—¶è¿›å…¥æ’æŸ¥
- `pyproject.toml` + `uv.lock` ä¿è¯ç¯å¢ƒå­—èŠ‚çº§ä¸€è‡´
- æ”¯æŒç¯å¢ƒç‰ˆæœ¬ç®¡ç†å’Œå›æ»š

---

### åœºæ™¯å››ï¼šVendor Agnosticï¼ˆä¸é”å®šæ‰§è¡Œå¼•æ“ï¼‰

> **é—®é¢˜**ï¼šRay `runtime_env` ä¸ Ray å¼ºç»‘å®š

**Environment Fabric æ–¹æ¡ˆ**ï¼š
- äº§å‡ºæ ‡å‡†çš„ `.venv` è·¯å¾„
- å¯è¢«ä»»ä½•æ‰§è¡Œå¼•æ“æ¶ˆè´¹

```python
# è¢« Ray æ¶ˆè´¹
@ray.remote(runtime_env={"py_executable": venv_python_path})
def ray_task(): ...

# è¢« Docker æŒ‚è½½
# docker run -v /mnt/nas/envs:/envs python:3.11 /envs/wf-001/.venv/bin/python script.py

# è¢« Kubernetes Job ä½¿ç”¨
# command: ["/mnt/nas/envs/wf-001/node-A/.venv/bin/python", "main.py"]

# è¢« subprocess è°ƒç”¨
subprocess.run([venv_python_path, "script.py"])
```

---

## ğŸ“Š æŠ€æœ¯å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | Environment Fabric | Ray Runtime Env |
|------|-------------------|-----------------|
| **æ„å»ºæ—¶æœº** | â±ï¸ AOT (æå‰æ„å»º) | â³ JIT (è¿è¡Œæ—¶æ„å»º) |
| **å­˜å‚¨æ¨¡å‹** | ğŸ’¾ NAS å…±äº« + Hardlink | ğŸ“¦ Node-local ç¼“å­˜ |
| **ç¯å¢ƒç¡®å®šæ€§** | ğŸ”’ `uv.lock` å­—èŠ‚çº§é”å®š | ğŸ² `pip list` æ¾æ•£å£°æ˜ |
| **å†·å¯åŠ¨æ—¶é—´** | ğŸš€ æ¯«ç§’çº§ | ğŸ¢ åˆ†é’Ÿçº§ï¼ˆå¤§ä¾èµ–ï¼‰ |
| **å¯è°ƒè¯•æ€§** | âœ… æŒä¹…åŒ–ç™½ç›’ | âŒ ä¸´æ—¶é»‘ç›’ |
| **è€¦åˆåº¦** | ğŸ”Œ Vendor Agnostic | ğŸ”— Ray å¼ºç»‘å®š |
| **ç£ç›˜æ•ˆç‡** | ğŸ’° èŠ‚çœ 90%+ | ğŸ“ˆ çº¿æ€§å¢é•¿ |

---

## ğŸ—ï¸ NAS å…±äº«å­˜å‚¨æ¶æ„

> [!IMPORTANT]
> **ç¡¬æ€§éƒ¨ç½²æ¡ä»¶**
> 
> `UV_CACHE_DIR` å¿…é¡»ä¸ `ENVS_BASE_PATH` åœ¨åŒä¸€ç‰©ç†åˆ†åŒºï¼ˆNAS æŒ‚è½½ç‚¹ï¼‰ï¼Œæ‰èƒ½ä½¿ç”¨ Hardlink æœºåˆ¶ã€‚

```
/mnt/nas/                           <- NFS/EFS æŒ‚è½½ç‚¹ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å…±äº«ï¼‰
â”‚
â”œâ”€â”€ envs/                           <- ENVS_BASE_PATH
â”‚   â”œâ”€â”€ workflow123_node123/        <- ç‹¬ç«‹ UV é¡¹ç›®
â”‚   â”‚   â”œâ”€â”€ .venv/                  <- è™šæ‹Ÿç¯å¢ƒ
â”‚   â”‚   â”‚   â””â”€â”€ bin/python          <- Ray py_executable æŒ‡å‘è¿™é‡Œ
â”‚   â”‚   â”œâ”€â”€ pyproject.toml          <- ä¾èµ–å£°æ˜
â”‚   â”‚   â”œâ”€â”€ uv.lock                 <- ç‰ˆæœ¬é”å®š
â”‚   â”‚   â””â”€â”€ metadata.json           <- ç¯å¢ƒå…ƒæ•°æ®
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ uv_cache/                       <- UV_CACHE_DIRï¼ˆå…¨å±€å…±äº«ç¼“å­˜ï¼‰
    â”œâ”€â”€ wheels/                     <- .whl åŒ…æ–‡ä»¶
    â””â”€â”€ archives/                   <- æºç åŒ…
            â†‘
            â””â”€â”€ Hardlink æŒ‡å‘å„ç¯å¢ƒçš„ .venv/lib/
```

---

## ğŸ“ è¯¦ç»†æŠ€æœ¯æ–‡æ¡£

æŠ€æœ¯ç»†èŠ‚å·²æ‹†åˆ†åˆ°ç‹¬ç«‹æ–‡æ¡£ï¼š

| æ–‡æ¡£ | æè¿° |
|------|------|
| [ğŸ“‹ PRD - äº§å“éœ€æ±‚æ–‡æ¡£](docs/PRD.md) | èƒŒæ™¯ã€ç›®æ ‡ã€åŠŸèƒ½èŒƒå›´ |
| [ğŸ›ï¸ ARD - æ¶æ„éœ€æ±‚æ–‡æ¡£](docs/ARD.md) | ç³»ç»Ÿæ¶æ„ã€ç»„ä»¶è®¾è®¡ã€å­˜å‚¨ç­–ç•¥ |
| [âš™ï¸ TRD - æŠ€æœ¯éœ€æ±‚æ–‡æ¡£](docs/TRD.md) | API è§„èŒƒã€é¡¹ç›®ç»“æ„ã€é…ç½®è¯´æ˜ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.11+
- [uv](https://github.com/astral-sh/uv) åŒ…ç®¡ç†å™¨
- NAS/å…±äº«å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- PostgreSQLï¼ˆå®¡è®¡æ•°æ®åº“ï¼‰

### 2. å®‰è£…ä¸è¿è¡Œ

```bash
# å…‹éš†é¡¹ç›®
git clone <repo-url>
cd env_manager

# å®‰è£…ä¾èµ–
uv sync

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.template .env
# ç¼–è¾‘ .env æ–‡ä»¶é…ç½® DATA_ROOTã€DATABASE_URL ç­‰

# å¯åŠ¨æœåŠ¡
uv run uvicorn src.api:app --host 0.0.0.0 --port 8000
```

### 3. åˆ›å»ºç¯å¢ƒ

```bash
# åˆ›å»ºä¸€ä¸ªæ–°ç¯å¢ƒ
curl -X POST http://localhost:8000/envs \
  -F "workflow_id=wf-001" \
  -F "node_id=node-A" \
  -F "packages=numpy>=1.24.0" \
  -F "packages=pandas>=2.0.0"
```

### 4. ä¸ Ray é›†æˆ

```python
import ray
import httpx

# 1. ä» Environment Fabric è·å–é¢„æ„å»ºç¯å¢ƒè·¯å¾„
resp = httpx.get("http://localhost:8000/envs/wf-001/node-A")
env_path = resp.json()["env_path"]
python_path = f"{env_path}/.venv/bin/python"

# 2. é…ç½® Ray ä½¿ç”¨è¯¥ç¯å¢ƒ
runtime_env = {"py_executable": python_path}

@ray.remote(runtime_env=runtime_env)
def my_task():
    import numpy as np
    return np.__version__

ray.init()
print(ray.get(my_task.remote()))
```

